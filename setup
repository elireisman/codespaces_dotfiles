#!/usr/bin/env bash

set +e

echo "[ELI DOTFILES] ($USER -> $HOME) Clearing package cache lock..."
sudo killall -9 dpkg apt apt-get
sudo dpkg --configure -a

set -eu +x -o pipefail

# Install tools
echo "[ELI DOTFILES] ($USER -> $HOME) Installing tools..."
sudo apt update -y
sudo apt install --allow-change-held-packages -y \
  curl \
  wget \
  vim \
  jq \
  ripgrep \
  procps \
  shellcheck \
  exuberant-ctags \
  rbenv \
  htop \
  tree \
  tshark \
  iftop

# sudo as "vscode" user for this part of the setup
if [[ "$USER" != vscode ]]; then
  sudo su - vscode
fi

# set up Git config
echo "[ELI DOTFILES] ($USER -> $HOME) Update Git config..."
for CHECKOUT in `ls /workspaces`; do
  pushd "/workspaces/$CHECKOUT"
  git config --local --replace-all user.email elireisman@github.com
  git config --local --replace-all user.name elireisman
  git config --local --replace-all github.user elireisman
  popd
done

# Install config files
echo "[ELI DOTFILES] ($USER -> $HOME) Installing config files..."
DOTFILES_BASE="/workspaces/.codespaces/.persistedshare/dotfiles"
cp "$DOTFILES_BASE/dotfiles/vimrc" "$HOME/.vimrc"
cp "$DOTFILES_BASE/dotfiles/bashrc" "$HOME/.bashrc_eli"
echo "source $HOME/.bashrc_eli" >> "$HOME/.bashrc"

# Install minimal Vim plugins
echo "[ELI DOTFILES] ($USER -> $HOME) Installing Vim plugins..."
mkdir -p "$HOME/.vim/pack/plugins/start"
git clone https://github.com/fatih/vim-go.git "$HOME/.vim/pack/plugins/start/vim-go"
vim +'GoInstallBinaries' +qa;
git clone https://github.com/rust-lang/rust.vim "$HOME/.vim/pack/plugins/start/rust.vim"
git clone https://github.com/scrooloose/nerdtree "$HOME/.vim/pack/plugins/start/nerdtree"
git clone https://github.com/ctrlpvim/ctrlp.vim.git "$HOME/.vim/pack/plugins/start/ctrlp.vim"
git clone https://github.com/vim-airline/vim-airline.git "$HOME/.vim/pack/plugins/start/vim-airline"
git clone https://github.com/chrisbra/unicode.vim.git "$HOME/.vim/pack/plugins/start/unicode.vim"

# Register SSH keys from GitHub
echo "[ELI DOTFILES] ($USER -> $HOME) Installing authorized SSH keys..."
mkdir -p "$HOME/.ssh"
curl --silent --fail "https://github.com/elireisman.keys" >> "$HOME/.ssh/authorized_keys"
